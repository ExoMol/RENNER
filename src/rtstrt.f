      SUBROUTINE STRTCH ( IW1    , IW3    , OVER   , TMAT   ,
     1                   ESTR   , SMAT   , VMAT   , UMAT   ,
     1                   EWRK   , HTR    , EIGVEC , WSPACE ,
     1                   IWORK  , IFAIL  , ICOMA  , NDBA   ,
     1                   IDOM   )
      IMPLICIT REAL*8 (A-H,O-Z)
C
      REAL*8 EIGVEC(NOBAS,NOBAS)
      REAL*8 WSPACE(8*NOBAS)
      INTEGER IWORK(5*NOBAS)
      INTEGER IFAIL(NOBAS)
C
      REAL*8 VL,VU
      INTEGER IL,IU
      REAL*8 ABSTOL
      INTEGER MOUT
      INTEGER INFO
C
      REAL*8 M1,M2,M3,M,U1,U3,U13,V,RHO,EPS,
     1      CR,SR,CSE,SNE,
     2      CRE,SRE,CORO,EPSP,EPSPP,EPSPPP
C
      REAL*8 AMASS(3,10)
C
      REAL*8 RHOE,FA1,FA2,FA3,FA4,FA5,FA6,FA7,FA8,
     1       AA1,AA3,
     2       F1A1,F2A1,F3A1,F4A1,F1A3,F2A3,F3A3,F4A3,
     3       F11,F1A11,F2A11,F3A11,F33,F1A33,F2A33,F3A33,
     4       F13,F1A13,F2A13,F3A13,
     5       F111,F1A111,F2A111,F333,F1A333,F2A333,
     6       F113,F1A113,F2A113,F133,F1A133,F2A133,
     7       F1111,FA1111,F3333,FA3333,F1113,FA1113,
     8       F1333,FA1333,F1133,FA1133,
     8       RE12 , RE32 , RHOREF , VMIN
C
      REAL*8 ETRIAL , RHOMAX , PNM1 , HBASE , HSTEP , EGUESS ,
     1      PREC
C
      REAL*8 THRSH1 , THRSH2 , THRSH3 , THRSH4 , THRSH5 ,
     1      THRSH6 , THRSH7 , THRSH8 , THRSH9 , THRSHX ,
     2      VELLGT , PLANCK , AVOGNO , DEGRAD , RADDEG ,
     3      PI
C
      REAL*8   B11,B13,B111,B133,B113,
     2      B1111,B1333,B1113,B1133,
     3      B11111,B13333,B11113,B11333,B11133,
     4      B31,B33,B311,B333,B313,
     5      B3111,B3333,B3113,B3133,
     6      B31111,B33333,B31113,B31333,B31133
C
      REAL*8   CR1,CR3,CR11,CR33,CR13,
     2      CR111,CR333,CR113,CR133,
     3      CR1111,CR3333,CR1113,CR1333,CR1133
C
      INTEGER NFIL1 , NFIL2 , NFIL3 , NFIL4 , NFIL5 , NFIL6 ,
     5       NFIL7 , NFIL8 , NFIL9 , NFIL10 ,
     6       NFIL11 , NFIL12 , NFIL13 , NFIL14 , NFIL15 ,
     7       NFIL16 , NFIL17 , NFIL18 , NFIL19 , NFIL20 ,
     6       ITEST  , IPRINT , NSTNR , NSTNIN , IREST ,
     7       IISOT , IQUAS , ISYMS , NISOT , NQUAS ,
     8       NUMQUA , NOPTIT , NOPTIM , IOBSER , NOBSER,
     9       ISOMAX , NATTS  , V0TYPE , IVAR(128) , PARMAX ,
     1       NUMPAR , PRTINT
C
      INTEGER V1 ,V2, V3 , V2MXP1, V2P1,
     1       NSTINT , NSERIN , NSERP , NSERQ , KQUA , NTEST ,
     2       NSEPP2 , NSEQP1 , MBASIS ,
     3       MDIM , NFSYM0, NFASY0, NFSYMJ, NFASYJ,
     4       KSTYPA(2) , LSTYPA(2) , JMAX , V2MAX , JMAXP1
C
      INTEGER IQUANT(9,10)
C
      LOGICAL SYMM
C
      REAL*8 RMK(2),AAS(2)
      INTEGER NOBAS,MBASP1,LENIW
      INTEGER IOSC1,IOSC3,I,J,K,L,IR,JL,IRN,IFA,IFB
      REAL*8 G,GC1,GC3,GC1113,GC3133,GC1133,GC3113
      INTEGER IW1(LENIW),IW3(LENIW),ICOMA(LENIW),NDBA(LENIW),
     1       IDOM(LENIW)
      INTEGER INDEX,ISTA,IEND,NOVA,L1,L2,K1,K2,IPOM,ISNT
      REAL*8  OVER(2,MBASP1,MBASP1),
     1       VMAT(NOBAS,NOBAS),SMAT(NOBAS,NOBAS),
     1       UMAT(2,NOBAS),ESTR(NOBAS),EWRK(NOBAS),
     1       TMAT(NOBAS,NOBAS),HTR(NOBAS)
      REAL*8  CONCOR,CONFC1,CONG11,CONG33,CONG13,
     1       POM,POM0,RCPSQ2,VMKJ
      COMMON /ISOTOP/ IQUANT,AMASS
C
      COMMON /EQUFCS/W11,W33,W13,W111,W333,W113,W133,
     1               W1111,W3333,W1113,W1333,W1133
C
C
      COMMON /VALUES/ RHO,EPS,EPSP,EPSPP,EPSPPP,
     1               CR,SR,CSE,SNE,CRE,SRE,CORO
C
      COMMON /MOLCUL/ RHOE,FA1,FA2,FA3,FA4,FA5,FA6,FA7,FA8,
     1               AA1,AA3,
     1               F11,F33,F13,F111,F333,F113,F133,
     1               F1111,F3333,F1113,F1333,F1133,
     2               F1,F1A1,F2A1,F3A1,F4A1,F3,F1A3,F2A3,F3A3,F4A3,
     3               F1A11,F2A11,F3A11,F1A33,F2A33,F3A33,
     4               F1A13,F2A13,F3A13,
     5               F1A111,F2A111,F1A333,F2A333,
     6               F1A113,F2A113,F1A133,F2A133,
     7               FA1111,FA3333,FA1113,
     8               FA1333,FA1133, R12RF1, R32RF1, R12RF2, R32RF2,
     8               RE12 , RE32 , M1 , M2 , M3 , M ,
     9               U1 , U3 , U13 , V ,
     1               SYMM
      COMMON /RENTEL/G1,G3,G11,G33,G13,G111,G333,G113,G133,
     1               G1111,G3333,G1113,G1333,G1133,
     2               GA1,GA2,GA3,GA4,GA5,GA6,GA7,GA8,
     2               G1A1,G2A1,G3A1,G4A1,G1A3,G2A3,G3A3,G4A3,
     3               G1A11,G2A11,G3A11,G1A33,G2A33,G3A33,
     4               G1A13,G2A13,G3A13,
     5               G1A111,G2A111,G1A333,G2A333,
     6               G1A113,G2A113,G1A133,G2A133,
     7               GA1111,GA3333,GA1113,
     8               GA1333,GA1133,
     1               HA1,HA2,HA3,HA4,HA5,HA6,HA7,HA8,
     2               H1A1,H2A1,H3A1,H4A1,H1A3,H2A3,H3A3,H4A3,
     3               H1A11,H2A11,H3A11,H1A33,H2A33,H3A33,
     4               H1A13,H2A13,H3A13,
     5               H1A111,H2A111,H1A333,H2A333,
     6               H1A113,H2A113,H1A133,H2A133,
     7               HA1111,HA3333,HA1113,
     8               HA1333,HA1133
C
      COMMON /INTEG/  ETRIAL , RHOMAX , PNM1 , HBASE , HSTEP , EGUESS ,
     1               RHOREF , VMINS1 , VMINS2 , ZTRIAL(2) , V0TYPE ,
     1               NSTINT , NSERIN , NSERP , NSERQ , KQUA , NTEST ,
     2               NSEPP2 , NSEQP1 , KSTYPA , LSTYPA
C
      COMMON /DIMEN/ NSURF,  MBASIS ,  V2MAX  , V2MXP1 ,
     1               JMAX   , JMAXP1 , MDIM   , NFSYM0 , NFASY0 ,
     2               NFSYMJ , NFASYJ , NFINTA
C
      COMMON /LSFIT/  PARMAX , NUMPAR , ISOMAX , IVAR
C
      include 'rensys.h'
C
      COMMON/BCOEFF/
     1      B11,B13,B111,B133,B113,
     2      B1111,B1333,B1113,B1133,
     3      B11111,B13333,B11113,B11333,B11133,
     4      B31,B33,B311,B333,B313,
     5      B3111,B3333,B3113,B3133,
     6      B31111,B33333,B31113,B31333,B31133
C
      COMMON/CRCOEF/
     1      CR1,CR3,CR11,CR33,CR13,
     2      CR111,CR333,CR113,CR133,
     3      CR1111,CR3333,CR1113,CR1333,CR1133
C
C
      COMMON/MORSE/RMK,AAS
      COMMON/MODIM/NOBAS,MBASP1,LENIW
C
      IOSC1=1
      IOSC3=2
      IF ( SYMM ) IOSC3=1
      CONCOR=PLANCK*AVOGNO*1.0E+16/(1.6E+01*PI*PI*VELLGT)
      CONFC1=2.0E+00*CONCOR
      CONG11=-CONFC1*(M1+M2)/(M1*M2)
      CONG33=-CONFC1*(M3+M2)/(M3*M2)
      CONG13=-CONFC1/M2
C
C ZERO ALL ELEMENTS IN THE HAMILTONIAN MATRIX
C
      DO 150 I=1,NOBAS
      DO 150 J=1,NOBAS
150   SMAT(J,I)=0.0E+00
C
      CALL YY(IOSC1,IW1,IW3,OVER,VMAT)
      G=W11
      DO 800 JL=1,NOBAS
      DO 800 IR=JL,NOBAS
800   SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
      CALL YY(IOSC3,IW3,IW1,OVER,VMAT)
      G=W33
      DO 1000 JL=1,NOBAS
      DO 1000 IR=JL,NOBAS
1000  SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
      CALL Y1Y2(IOSC1,IOSC3,IW1,IW3,OVER,VMAT)
      G=W13
      DO 1200 JL=1,NOBAS
      DO 1200 IR=JL,NOBAS
1200  SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
      CALL YYY(IOSC1,IW1,IW3,OVER,VMAT)
      G=W111
      DO 1400 JL=1,NOBAS
      DO 1400 IR=JL,NOBAS
1400  SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
      CALL YYY(IOSC3,IW3,IW1,OVER,VMAT)
      G=W333
      DO 1600 JL=1,NOBAS
      DO 1600 IR=JL,NOBAS
1600  SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
C
      CALL Y1Y1Y2(IOSC1,IOSC3,IW1,IW3,OVER,VMAT)
      G=W113
      DO 1800 JL=1,NOBAS
      DO 1800 IR=JL,NOBAS
1800  SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
      CALL Y1Y1Y2(IOSC3,IOSC1,IW3,IW1,OVER,VMAT)
      G=W133
      DO 2000 JL=1,NOBAS
      DO 2000 IR=JL,NOBAS
2000  SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
C
      CALL YYYY(IOSC1,IW1,IW3,OVER,VMAT)
      G=W1111
      DO 2200 JL=1,NOBAS
      DO 2200 IR=JL,NOBAS
2200  SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
C
      CALL YYYY(IOSC3,IW3,IW1,OVER,VMAT)
      G=W3333
      DO 2400 JL=1,NOBAS
      DO 2400 IR=JL,NOBAS
2400  SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
C
      CALL Y13Y2(IOSC1,IOSC3,IW1,IW3,OVER,VMAT)
      G=W1113
      DO 2600 JL=1,NOBAS
      DO 2600 IR=JL,NOBAS
2600  SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
C
      CALL Y13Y2(IOSC3,IOSC1,IW3,IW1,OVER,VMAT)
      G=W1333
      DO 2800 JL=1,NOBAS
      DO 2800 IR=JL,NOBAS
2800  SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
C
      CALL Y12Y22(IOSC1,IOSC3,IW1,IW3,OVER,VMAT)
      G=W1133
      DO 3000 JL= 1,NOBAS
      DO 3000 IR=JL,NOBAS
3000  SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
C
      CALL PP(IOSC1,IW1,IW3,OVER,VMAT)
      G=CONG11
      DO 3200 JL=1,NOBAS
      DO 3200 IR=JL,NOBAS
      SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
3200  CONTINUE
C
C
      CALL PP(IOSC3,IW3,IW1,OVER,VMAT)
      G=CONG33
      DO 3400 JL=1,NOBAS
      DO 3400 IR=JL,NOBAS
      SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
3400  CONTINUE
C
C
      CALL P1P2(IOSC1,IOSC3,IW1,IW3,OVER,VMAT)
      G=-2.0E+00*CONG13
      DO 3600 JL=1,NOBAS
      DO 3600 IR=JL,NOBAS
3600  SMAT(IR,JL)=SMAT(IR,JL)+G*VMAT(IR,JL)
C
C
      DO 3610 JL=1,NOBAS-1
      DO 3610 IR=JL+1,NOBAS
3610  SMAT(JL,IR)=SMAT(IR,JL)
C
C
      IF (ITEST.LE.0) GOTO 3620
      WRITE(NFIL6,9000)
      WRITE(NFIL6,9100)((SMAT(IR,JL),JL=1,NOBAS),IR=1,NOBAS)
      WRITE(NFIL6,9100)(SMAT(IR,IR),IR=1,NOBAS)
C
C
3620  RCPSQ2=1.0E+00/SQRT(2.0E+00)
C
C CONSTRUCT THE U MATRIX, WHICH TRANSFORMS INTO SYMMETRIZED VIBRATIONAL
C BASIS FUNCTIONS.
C
      IF ( SYMM ) GOTO 3800
      DO 3700 I=1,NOBAS
      NDBA(I)=1
      ICOMA(I)=I-1
      UMAT(1,I)=1.0E+00
3700  UMAT(2,I)=0.0E+00
      GOTO 4100
3800  NOVA=KSTYPA(1)
      IFA=0
      IFB=0
      DO 4000 I=1,NOBAS
      V1=IW1(I)
      V3=IW3(I)
      IF (V3 .LT. V1) GOTO 4000
      IF (V3 .GT. V1) GOTO 3900
      IFA=IFA+1
      NDBA(IFA)=1
      ICOMA(IFA)=I-1
      UMAT(1,IFA)=1.0E+00
      UMAT(2,IFA)=0.0E+00
      GOTO 4000
3900  IFA=IFA+1
      IFB=IFB+1
      NDBA(IFA)=2
      ICOMA(IFA)=I-1
      UMAT(1,IFA)=RCPSQ2
      UMAT(2,IFA)=RCPSQ2
      NDBA(NOVA+IFB)=2
      ICOMA(NOVA+IFB)=I-1
      UMAT(1,NOVA+IFB)=RCPSQ2
      UMAT(2,NOVA+IFB)=-RCPSQ2
4000  CONTINUE
C
4100  CONTINUE
      IF (IPRINT .GT. 0) THEN
      WRITE(NFIL6,9200) (I,I=1,2)
      DO 4200 I=1,NOBAS
      J=NDBA(I)
4200  WRITE(NFIL6,9300) I,ICOMA(I),(UMAT(K,I),K=1,J)
      ENDIF
      DO 4500 I=1,NOBAS
      K2=NDBA(I)
      DO 4500 J=I,NOBAS
      L2=NDBA(J)
      POM=0.0E0
      DO 4400 K=1,K2
      K1=ICOMA(I)+K
      POM0=0.0E0
      DO 4300 L=1,L2
      L1=ICOMA(J)+L
4300  POM0=POM0+SMAT(L1,K1)*UMAT(L,J)
      POM=POM+UMAT(K,I)*POM0
4400  CONTINUE
      VMAT(I,J)=POM
      VMAT(J,I)=POM
4500  CONTINUE
      IF (ITEST.LE.0) GOTO 4800
      WRITE(NFIL6,9400)
      WRITE(NFIL6,9500)((VMAT(I,J),J=1,NOBAS),I=1,NOBAS)
      WRITE(NFIL6,9500)(VMAT(I,I),I=1,NOBAS)
C
      DO 4700 I=1,NOBAS
      DO 4600 J=1,NOBAS
      IDOM(J)=0
      IF(ABS(VMAT(I,J)).LT.1.0E-2)GOTO 4600
      IDOM(J)=1
4600  CONTINUE
      WRITE(NFIL6,9600)(IDOM(J),J=1,NOBAS)
4700  CONTINUE
4800  CONTINUE
C
C
C
      IPOM=0
      ISNT=KSTYPA(1)
      DO 4900 K=1,ISNT
      DO 4900 L=K,ISNT
4900  SMAT(L,K)=VMAT(L,K)
C
      CALL DIASTR (SMAT,HTR,EIGVEC,WSPACE,IWORK,
     1             IFAIL,ISNT,NOBAS,INFO)
C
        IF (INFO .NE. 0) THEN
          WRITE (NFIL6,9700)
          STOP
        ENDIF
C
      ISNT=KSTYPA(1)
      DO 4920 K=1,ISNT
      DO 4920 L=1,ISNT
4920    VMAT(L,K)=EIGVEC(L,K)
      DO 5000 K=1,ISNT
5000  ESTR(K+IPOM)=HTR(K)
      IF (KSTYPA(2) .EQ. 0) GOTO 5400
      IPOM=ISNT
      ISNT=KSTYPA(2)
      DO 5100 K=1,ISNT
      DO 5100 L=K,ISNT
5100  SMAT(L,K)=VMAT(L+IPOM,K+IPOM)
C
      CALL DIASTR (SMAT,HTR,EIGVEC,WSPACE,IWORK,
     1             IFAIL,ISNT,NOBAS,INFO)
C
        IF (INFO .NE. 0) THEN
          WRITE (NFIL6,9700)
          STOP
        ENDIF
C
      DO 5120 K=1,ISNT
      DO 5120 L=1,ISNT
5120    VMAT(L+IPOM,K+IPOM)=EIGVEC(L,K)
      DO 5200 K=1,ISNT
5200  ESTR(K+IPOM)=HTR(K)
C
5400  CONTINUE
C
      DO 5420 K=IPOM+1,NOBAS
      DO 5420 L=1,IPOM
5420  VMAT(L,K)=0.0E0
C
      DO 5440 K=1,IPOM
      DO 5440 L=IPOM+1,NOBAS
5440  VMAT(L,K)=0.0E0
C
      DO 5600 J=1,NOBAS
C
      DO 5480 I=1,NOBAS
5480  TMAT(I,J)=0.0E0
C
      DO 5600 K=1,NOBAS
      VMKJ=VMAT(K,J)
      ISTA=ICOMA(K)+1
      IEND=ISTA+NDBA(K)-1
      INDEX=0
C
      DO 5500 I=ISTA,IEND
      INDEX=INDEX+1
5500  TMAT(I,J)=TMAT(I,J)+UMAT(INDEX,K)*VMKJ
C
5600  CONTINUE
C
      IF (IPRINT .EQ. 0) RETURN
C
      WRITE (NFIL6,9800)
      DO 6100 I=1,LSTYPA(1)
      MAXC=0
      TEST=0.0E+00
      DO 6000  K=1,NOBAS
      IF (ABS(TMAT(K,I)) .GT. TEST) THEN
            MAXC=K
            TEST=ABS(TMAT(K,I))
      ENDIF
6000  CONTINUE
      IM1=I-1
6100  WRITE (NFIL6,9810) IM1,IW1(MAXC),IW3(MAXC),ESTR(I)
C
      IF (KSTYPA(2) .EQ. 0) RETURN
C
      IPOM=KSTYPA(1)
      WRITE (NFIL6,9900)
      DO 7100 I=1,LSTYPA(2)
      MAXC=0
      TEST=0.0E+00
      INDEX=KSTYPA(1)+I
      DO 7000  K=1,NOBAS
      IF (ABS(TMAT(K,INDEX)) .GT. TEST) THEN
            MAXC=K
            TEST=ABS(TMAT(K,INDEX))
      ENDIF
7000  CONTINUE
      IM1=I-1
7100  WRITE (NFIL6,9810) IM1,IW1(MAXC),IW3(MAXC),ESTR(IPOM+I)
      RETURN
C
9000  FORMAT('0','  STRETCHING MATRIX FROM STRTCH',//)
9100  FORMAT(5F12.3)
9200  FORMAT('1',5X,12('*'),' U MATRIX ',12('*')//
     1      ' ',8X,'I',3X,'J',1X,2(3X,'U(I,J+',I1,')')//)
9300  FORMAT(5X,2I4,1X,2F11.6)
9400  FORMAT('0','      SYMMETRIZED HAMILTONIAN MATRIX FOR ',
     1                'THE STRETCHING MOTION',//)
9500  FORMAT(5F12.3)
9600  FORMAT(I4,39I1)
9700  FORMAT(1H0,'  RENTEL.STR.ERR  MATRIX DIAGONALIZATION FAILED ',
     1          'IN STRTCH'/)
9800  FORMAT('0',5X,12('*'),' A1 STRETCHING FUNCTIONS ',12('*')//
     1      ' ',8X,'  NS  ',8X,'N1',8X,'N3',12X,'ENERGY/CM-1'//)
9810  FORMAT(' ',12X,I2,8X,I2,8X,I2,10X,F14.5)
9900  FORMAT('0',5X,12('*'),' B2 STRETCHING FUNCTIONS ',12('*')//
     1      ' ',8X,'  NS  ',8X,'N1',8X,'N3',12X,'ENERGY/CM-1'//)
      END
C
C
      SUBROUTINE DIASTR (SMAT,HTR,EIGVEC,WSPACE,IWORK,
     1           IFAIL,ISNT,NOBAS,INFO)

C
      CHARACTER*1 JOBZ,RANGE,UPLO
      REAL*8 VL,VU,ABSTOL
      REAL*8 SMAT(NOBAS,NOBAS),HTR(NOBAS),EIGVEC(NOBAS,NOBAS),
     1       WSPACE(8*ISNT)
      INTEGER IL,IU,IWORK(5*ISNT),IFAIL(ISNT)

C
        JOBZ='V'
        RANGE='A'
        UPLO='L'
        VL=0.0
        VU=0.0
        IL=1
        IU=1
        ABSTOL=0.0D+00
        MOUT=1
        CALL DSYEVX(JOBZ,RANGE,UPLO,
     1              ISNT,SMAT,NOBAS,
     2              VL,VU,IL,IU,
     3              ABSTOL,
     4              MOUT,HTR,   EIGVEC,NOBAS,  
     5              WSPACE,8*ISNT,   IWORK,
     6              IFAIL,INFO)
       RETURN
       END
