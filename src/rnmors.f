      DOUBLE PRECISION FUNCTION SCALIN(A,AL,N)
      IMPLICIT REAL*8 (A-H,O-Z)
C---------------------------------------
C     NORMALIZING THE MORSE-OSCILLATOR EIGENFUNCTIONS
C     ROUTINE CALCULATES THE NATURAL LOGARITHM OF THE NORMALIZATION
C     FACTOR [MEASURED IN ANGSTROM**(-1/2)]
C----------------------------------------
      X=AL+DFLOAT(N)+1.0
      XR=X
      Y1=0.0
      IF(X.LT.12.0)GOTO 3
      IR=INT(X/3.0D+00)
      RR=DFLOAT(IR)
      XR=X-RR
      DO 2 II=1,IR
    2 Y1=Y1+LOG(X-DFLOAT(II))
    3 XLNFAC=FACLOG(N)
      Y2=XLNFAC-GAMMLN(XR)
      SC=0.5D+00*(LOG(A*AL)+Y2-Y1)
      SCALIN=SC
      RETURN
      END
C
C
C
C
      DOUBLE PRECISION FUNCTION FMORSE(N,RVAL,RK,R0,A,SCF)
      IMPLICIT REAL*8 (A-H,O-Z)
C--------------------------------------------------------
C      CALCULATES MORSE OSCILLATOR EIGENFUNCTIONS
C--------------------------------------------------------
      R=RVAL
      X=2.0*RK*EXP(-A*(R-R0))
      RN=DFLOAT(N)
      ALPHA=2.0*(RK-RN)-1.0
      FCTVAL=EXP(SCF+(ALPHA*LOG(X)-X)/2.0)*PLAG(N,ALPHA,X)
      FMORSE=FCTVAL
      RETURN
      END
C
C
      DOUBLE PRECISION FUNCTION DMORSE(N,RVAL,RK,R0,A,SCF,FVAL)
      IMPLICIT REAL*8 (A-H,O-Z)
C--------------------------------------------------------
C      CALCULATES THE FIRST DERIVATIVE OF A MORSE 
C      OSCILLATOR EIGENFUNCTION
C--------------------------------------------------------
      R=RVAL
      X=2.0*RK*EXP(-A*(R-R0))
      DXDR=-A*X
      RN=DFLOAT(N)
      ALPHA=2.0*(RK-RN)-1.0
      FCTVAL=0.5D+00*(ALPHA/X-1.0D+00)*FVAL
     1   +EXP(SCF+(ALPHA*LOG(X)-X)/2.0)*DLAG(N,ALPHA,X)
      DMORSE=FCTVAL*DXDR
      RETURN
      END
C
C
      DOUBLE PRECISION FUNCTION PLAG(N,A,X)
C--------------------------------------------------------
C      CALCULATES ASSOCIATED LAGUERRE POLYNOMIALS
C--------------------------------------------------------
      IMPLICIT REAL*8 (A-H,O-Z)
      QQ0=1.0D+00
      IF (N .EQ. 0) THEN
           PLAG=QQ0
           RETURN
      ENDIF
C
      QQ1=A+1.0D+00-X
      IF (N .EQ. 1) THEN
           PLAG=QQ1
           RETURN
      ENDIF
C
      DO 10 JJ=2,N
      XJJ=DFLOAT(JJ)
      QQ2=((2.0D+00*XJJ+A-1.0D+00-X)*QQ1
     1    -(        XJJ+A-1.0D+00  )*QQ0)/XJJ
      QQ0=QQ1
10    QQ1=QQ2
      PLAG=QQ2
      RETURN
      END
C
C
      DOUBLE PRECISION FUNCTION DLAG(N,A,X)
C--------------------------------------------------------
C      CALCULATES DERIVATIVES (WITH RESPECT TO X)
C      OF ASSOCIATED LAGUERRE POLYNOMIALS
C--------------------------------------------------------
      IMPLICIT REAL*8 (A-H,O-Z)
      QQ0=0.0D+00
      IF (N .EQ. 0) THEN
           DLAG=QQ0
           RETURN
      ENDIF
C
      QQ1=-1.0D+00
      IF (N .EQ. 1) THEN
           DLAG=QQ1
           RETURN
      ENDIF
C
      DO 10 JJ=2,N
      XJJ=DFLOAT(JJ)
      QQ2=((2.0D+00*XJJ+A-1.0D+00-X)*QQ1
     1    -(        XJJ+A-1.0D+00  )*QQ0
     2    -PLAG(JJ-1,A,X))/XJJ
      QQ0=QQ1
10    QQ1=QQ2
      DLAG=QQ2
      RETURN
      END
C
C
      DOUBLE PRECISION FUNCTION GAMMLN(XX)
      IMPLICIT REAL*8 (A-H,O-Z)
      REAL*8   COF(6),STP,HALF,ONE,FPF,X,TMP,SER
      DATA COF,STP/76.18009173D0,-86.50532033D0,24.01409822D0,
     *    -1.231739516D0,.120858003D-2,-.536382D-5,2.50662827465D0/
      DATA HALF,ONE,FPF/0.5D0,1.0D0,5.5D0/
      X=XX-ONE
      TMP=X+FPF
      TMP=(X+HALF)*LOG(TMP)-TMP
      SER=ONE
      DO 11 J=1,6
        X=X+ONE
        SER=SER+COF(J)/X
11    CONTINUE
      GAMMLN=TMP+LOG(STP*SER)
      RETURN
      END
C
C
      SUBROUTINE GENMOS ( PHI ,  DPH , RK11 , RK31 , RK12 , RK32 ,
     1                    MBASI1 , MBASI2 )
      IMPLICIT REAL*8 (A-H,O-Z)
      REAL*8 M1,M2,M3,M,U1,U3,U13,V,RHO,EPS,
     1      CR,SR,CSE,SNE,
     2      CRE,SRE,CORO,EPSP,EPSPP,EPSPPP
C
      REAL*8 AMASS(3,10)
C
      REAL*8 RHOE,FA1,FA2,FA3,FA4,FA5,FA6,FA7,FA8,
     1       AA1,AA3,
     2       F1A1,F2A1,F3A1,F4A1,F1A3,F2A3,F3A3,F4A3,
     3       F11,F1A11,F2A11,F3A11,F33,F1A33,F2A33,F3A33,
     4       F13,F1A13,F2A13,F3A13,
     5       F111,F1A111,F2A111,F333,F1A333,F2A333,
     6       F113,F1A113,F2A113,F133,F1A133,F2A133,
     7       F1111,FA1111,F3333,FA3333,F1113,FA1113,
     8       F1333,FA1333,F1133,FA1133,
     8       RE12 , RE32 , RHOREF , VMIN
C
      REAL*8 ETRIAL , RHOMAX , PNM1 , HBASE , HSTEP , EGUESS ,
     1      PREC
C
      REAL*8 THRSH1 , THRSH2 , THRSH3 , THRSH4 , THRSH5 ,
     1      THRSH6 , THRSH7 , THRSH8 , THRSH9 , THRSHX ,
     2      VELLGT , PLANCK , AVOGNO , DEGRAD , RADDEG ,
     3      PI
C
      REAL*8   B11,B13,B111,B133,B113,
     2      B1111,B1333,B1113,B1133,
     3      B11111,B13333,B11113,B11333,B11133,
     4      B31,B33,B311,B333,B313,
     5      B3111,B3333,B3113,B3133,
     6      B31111,B33333,B31113,B31333,B31133
C
      REAL*8   CR1,CR3,CR11,CR33,CR13,
     2      CR111,CR333,CR113,CR133,
     3      CR1111,CR3333,CR1113,CR1333,CR1133
C
      INTEGER NFIL1 , NFIL2 , NFIL3 , NFIL4 , NFIL5 , NFIL6 ,
     5       NFIL7 , NFIL8 , NFIL9 , NFIL10 ,
     6       NFIL11 , NFIL12 , NFIL13 , NFIL14 , NFIL15 ,
     7       NFIL16 , NFIL17 , NFIL18 , NFIL19 , NFIL20 ,
     6       ITEST  , IPRINT , NSTNR , NSTNIN , IREST ,
     7       IISOT , IQUAS , ISYMS , NISOT , NQUAS ,
     8       NUMQUA , NOPTIT , NOPTIM , IOBSER , NOBSER,
     9       ISOMAX , NATTS  , V0TYPE , IVAR(128) , PARMAX ,
     1       NUMPAR , PRTINT , V2VALU
C
      INTEGER V1 ,V2, V3 , V2MXP1, V2P1,
     1       NSTINT , NSERIN , NSERP , NSERQ , KQUA , NTEST ,
     2       NSEPP2 , NSEQP1 , MBASIS ,
     3       MDIM , NFSYM0, NFASY0, NFSYMJ, NFASYJ,
     4       KSTYPA(2) , LSTYPA(2) , JMAX , V2MAX , JMAXP1
C
      INTEGER IQUANT(9,10)
C
      LOGICAL SYMM
C
      REAL*8 RMK(2),AAS(2),PHI(NSTSTR),DPH(NSTSTR),DER(4),EREST(4)
      INTEGER NOBAS,NOVIBS,LENIW
C
      COMMON / NUMMOR / R12BEG,R12END,R32BEG,R32END,NSTSTR
C
      COMMON /ISOTOP/ IQUANT,AMASS
C
      COMMON /VALUES/ RHO,EPS,EPSP,EPSPP,EPSPPP,
     1               CR,SR,CSE,SNE,CRE,SRE,CORO
C
      COMMON /MOLCUL/ RHOE,FA1,FA2,FA3,FA4,FA5,FA6,FA7,FA8,
     1               AA1,AA3,
     1               F11,F33,F13,F111,F333,F113,F133,
     1               F1111,F3333,F1113,F1333,F1133,
     2               F1,F1A1,F2A1,F3A1,F4A1,F3,F1A3,F2A3,F3A3,F4A3,
     3               F1A11,F2A11,F3A11,F1A33,F2A33,F3A33,
     4               F1A13,F2A13,F3A13,
     5               F1A111,F2A111,F1A333,F2A333,
     6               F1A113,F2A113,F1A133,F2A133,
     7               FA1111,FA3333,FA1113,
     8               FA1333,FA1133, R12RF1, R32RF1, R12RF2, R32RF2,
     8               RE12 , RE32 , M1 , M2 , M3 , M ,
     9               U1 , U3 , U13 , V ,
     1               SYMM
      COMMON /RENTEL/G1,G3,G11,G33,G13,G111,G333,G113,G133,
     1               G1111,G3333,G1113,G1333,G1133,
     2               GA1,GA2,GA3,GA4,GA5,GA6,GA7,GA8,
     2               G1A1,G2A1,G3A1,G4A1,G1A3,G2A3,G3A3,G4A3,
     3               G1A11,G2A11,G3A11,G1A33,G2A33,G3A33,
     4               G1A13,G2A13,G3A13,
     5               G1A111,G2A111,G1A333,G2A333,
     6               G1A113,G2A113,G1A133,G2A133,
     7               GA1111,GA3333,GA1113,
     8               GA1333,GA1133,
     1               HA1,HA2,HA3,HA4,HA5,HA6,HA7,HA8,
     2               H1A1,H2A1,H3A1,H4A1,H1A3,H2A3,H3A3,H4A3,
     3               H1A11,H2A11,H3A11,H1A33,H2A33,H3A33,
     4               H1A13,H2A13,H3A13,
     5               H1A111,H2A111,H1A333,H2A333,
     6               H1A113,H2A113,H1A133,H2A133,
     7               HA1111,HA3333,HA1113,
     8               HA1333,HA1133
C
      COMMON /INTEG/  ETRIAL , RHOMAX , PNM1 , HBASE , HSTEP , EGUESS ,
     1               RHOREF , VMINS1 , VMINS2 , ZTRIAL(2) , V0TYPE ,
     1               NSTINT , NSERIN , NSERP , NSERQ , KQUA , NTEST ,
     2               NSEPP2 , NSEQP1 , KSTYPA , LSTYPA
C
      COMMON /DIMEN/ NSURF,  MBASIS ,  V2MAX  , V2MXP1 ,
     1               JMAX   , JMAXP1 , MDIM   , NFSYM0 , NFASY0 ,
     2               NFSYMJ , NFASYJ , NFINTA
C
      COMMON /LSFIT/  PARMAX , NUMPAR , ISOMAX , IVAR
C
      include 'rensys.h'
C
      COMMON/BCOEFF/
     1      B11,B13,B111,B133,B113,
     2      B1111,B1333,B1113,B1133,
     3      B11111,B13333,B11113,B11333,B11133,
     4      B31,B33,B311,B333,B313,
     5      B3111,B3333,B3113,B3133,
     6      B31111,B33333,B31113,B31333,B31133
C
      COMMON/CRCOEF/
     1      CR1,CR3,CR11,CR33,CR13,
     2      CR111,CR333,CR113,CR133,
     3      CR1111,CR3333,CR1113,CR1333,CR1133
C
C
      COMMON/MORSE/RMK,AAS
      COMMON/MODIM/NOBAS,NOVIBS,LENIW
C
      RSTEP1 = (R12END - R12BEG)/(NSTSTR-1)
      RSTEP3 = (R32END - R32BEG)/(NSTSTR-1)
C
      DO 1010 JJ=0,MBASI1
      RN=DFLOAT(JJ)
      ALPHA=2.0D+00*(RK11-RN)-1.0D+00
      SCF=SCALIN(AA1,ALPHA,JJ)
      DO 1000 II=1,NSTSTR
      RVAL=R12BEG+DFLOAT(II-1)*RSTEP1
      PHI(II)=FMORSE(JJ,RVAL,RK11,R12RF1,AA1,SCF)
1000  DPH(II)=DMORSE(JJ,RVAL,RK11,R12RF1,AA1,SCF,PHI(II))
C
1010  WRITE (NFIL37,REC=JJ+1) (PHI(II), II=1,NSTSTR),
     1                        (DPH(II), II=1,NSTSTR)
C
      DO 1030 JJ=0,MBASI1
      RN=DFLOAT(JJ)
      ALPHA=2.0D+00*(RK31-RN)-1.0D+00
      SCF=SCALIN(AA3,ALPHA,JJ)
      DO 1020 II=1,NSTSTR
      RVAL=R32BEG+DFLOAT(II-1)*RSTEP3
      PHI(II)=FMORSE(JJ,RVAL,RK31,R32RF1,AA3,SCF)
1020  DPH(II)=DMORSE(JJ,RVAL,RK31,R32RF1,AA3,SCF,PHI(II))
C
1030  WRITE (NFIL38,REC=JJ+1) (PHI(II), II=1,NSTSTR),
     1                        (DPH(II), II=1,NSTSTR)
C
      DO 1050 JJ=0,MBASI2
      RN=DFLOAT(JJ)
      ALPHA=2.0D+00*(RK12-RN)-1.0D+00
      SCF=SCALIN(AA1,ALPHA,JJ)
      DO 1040 II=1,NSTSTR
      RVAL=R12BEG+DFLOAT(II-1)*RSTEP1
      PHI(II)=FMORSE(JJ,RVAL,RK12,R12RF2,AA1,SCF)
1040  DPH(II)=DMORSE(JJ,RVAL,RK12,R12RF2,AA1,SCF,PHI(II))
C
1050  WRITE (NFIL39,REC=JJ+1) (PHI(II), II=1,NSTSTR),
     1                        (DPH(II), II=1,NSTSTR)
C
      DO 1070 JJ=0,MBASI2
      RN=DFLOAT(JJ)
      ALPHA=2.0D+00*(RK32-RN)-1.0D+00
      SCF=SCALIN(AA3,ALPHA,JJ)
      DO 1060 II=1,NSTSTR
      RVAL=R32BEG+DFLOAT(II-1)*RSTEP3
      PHI(II)=FMORSE(JJ,RVAL,RK32,R32RF2,AA3,SCF)
1060  DPH(II)=DMORSE(JJ,RVAL,RK32,R32RF2,AA3,SCF,PHI(II))
C
1070  WRITE (NFIL40,REC=JJ+1) (PHI(II), II=1,NSTSTR),
     1                        (DPH(II), II=1,NSTSTR)
C
      RETURN
      END
C
C
      SUBROUTINE GENYPN ( PHIL1 , PHIR1 ,  PHIL3 , PHIR3 ,
     1                    DERL1 , DERR1 ,  DERL3 , DERR3 ,
     1                    Y1P1 , Y1P2 , Y1P3 , Y1P4 ,
     1                    Y3P1 , Y3P2 , Y3P3 , Y3P4 ,
     1                    Y1P0M , Y1P1M , Y1P2M , Y1P3M , Y1P4M ,
     1                    Y3P0M , Y3P1M , Y3P2M , Y3P3M , Y3P4M ,
     1                    PY1P0 , PY1P1 , PY1P2 , PY1P3 ,
     1                    PY3P0 , PY3P1 , PY3P2 , PY3P3 ,
     1                    VMAT , TMATL , TMATR , SMAT , WMAT ,
     1                    IW1  , IW3 , NINTOP , NOBAL , NOBAR ,
     1                    MBASIL , MBASIR , MBALP1 , MBARP1 ,
     1                    NOVIBS )
      IMPLICIT REAL*8 (A-H,O-Z)
C
      REAL*8 M1,M2,M3,M,U1,U3,U13,V,RHO,EPS,
     1      CR,SR,CSE,SNE,
     2      CRE,SRE,CORO,EPSP,EPSPP,EPSPPP
C
      REAL*8 AMASS(3,10)
C
      REAL*8 RHOE,FA1,FA2,FA3,FA4,FA5,FA6,FA7,FA8,
     1       AA1,AA3,
     2       F1A1,F2A1,F3A1,F4A1,F1A3,F2A3,F3A3,F4A3,
     3       F11,F1A11,F2A11,F3A11,F33,F1A33,F2A33,F3A33,
     4       F13,F1A13,F2A13,F3A13,
     5       F111,F1A111,F2A111,F333,F1A333,F2A333,
     6       F113,F1A113,F2A113,F133,F1A133,F2A133,
     7       F1111,FA1111,F3333,FA3333,F1113,FA1113,
     8       F1333,FA1333,F1133,FA1133,
     8       RE12 , RE32 , RHOREF , VMIN
C
      REAL*8 ETRIAL , RHOMAX , PNM1 , HBASE , HSTEP , EGUESS ,
     1      PREC
C
      REAL*8 THRSH1 , THRSH2 , THRSH3 , THRSH4 , THRSH5 ,
     1      THRSH6 , THRSH7 , THRSH8 , THRSH9 , THRSHX ,
     2      VELLGT , PLANCK , AVOGNO , DEGRAD , RADDEG ,
     3      PI
C
      REAL*8   B11,B13,B111,B133,B113,
     2      B1111,B1333,B1113,B1133,
     3      B11111,B13333,B11113,B11333,B11133,
     4      B31,B33,B311,B333,B313,
     5      B3111,B3333,B3113,B3133,
     6      B31111,B33333,B31113,B31333,B31133
C
      REAL*8   CR1,CR3,CR11,CR33,CR13,
     2      CR111,CR333,CR113,CR133,
     3      CR1111,CR3333,CR1113,CR1333,CR1133
C
      INTEGER NFIL1 , NFIL2 , NFIL3 , NFIL4 , NFIL5 , NFIL6 ,
     5       NFIL7 , NFIL8 , NFIL9 , NFIL10 ,
     6       NFIL11 , NFIL12 , NFIL13 , NFIL14 , NFIL15 ,
     7       NFIL16 , NFIL17 , NFIL18 , NFIL19 , NFIL20 ,
     6       ITEST  , IPRINT , NSTNR , NSTNIN , IREST ,
     7       IISOT , IQUAS , ISYMS , NISOT , NQUAS ,
     8       NUMQUA , NOPTIT , NOPTIM , IOBSER , NOBSER,
     9       ISOMAX , NATTS  , V0TYPE , IVAR(128) , PARMAX ,
     1       NUMPAR , PRTINT , V2VALU
C
      INTEGER V1 ,V2, V3 , V2MXP1, V2P1, V1P1 ,
     1       NSTINT , NSERIN , NSERP , NSERQ , KQUA , NTEST ,
     2       NSEPP2 , NSEQP1 , MBASIS ,
     3       MDIM , NFSYM0, NFASY0, NFSYMJ, NFASYJ,
     4       KSTYPA(2) , LSTYPA(2) , JMAX , V2MAX , JMAXP1
C
      INTEGER IQUANT(9,10)
C
      LOGICAL SYMM
C
      REAL*8 RMK(2),AAS(2),PHIL1(NSTSTR),PHIR1(NSTSTR),
     1                   PHIL3(NSTSTR),PHIR3(NSTSTR),
     1                   DERL1(NSTSTR),DERR1(NSTSTR),
     1                   DERL3(NSTSTR),DERR3(NSTSTR),
     1     Y1P1(NSTSTR),Y1P2(NSTSTR),Y1P3(NSTSTR),Y1P4(NSTSTR),
     1     Y3P1(NSTSTR),Y3P2(NSTSTR),Y3P3(NSTSTR),Y3P4(NSTSTR),
     1     Y1P0M(MBALP1,MBARP1),Y1P1M(MBALP1,MBARP1),
     1     Y1P2M(MBALP1,MBARP1),Y1P3M(MBALP1,MBARP1),
     1     Y1P4M(MBALP1,MBARP1),
     1     Y3P0M(MBALP1,MBARP1),Y3P1M(MBALP1,MBARP1),
     1     Y3P2M(MBALP1,MBARP1),Y3P3M(MBALP1,MBARP1),
     1     Y3P4M(MBALP1,MBARP1),VMAT(NOBAL,NOBAR),
     1     TMATL(NOBAL,NOBAL),TMATR(NOBAR,NOBAR),
     1     SMAT(NOBAL,NOBAR,NINTOP),WMAT(NOBAR,NOBAL)
      REAL*8 PY1P0(MBALP1,MBARP1),PY1P1(MBALP1,MBARP1),
     1       PY1P2(MBALP1,MBARP1),PY1P3(MBALP1,MBARP1),
     1       PY3P0(MBALP1,MBARP1),PY3P1(MBALP1,MBARP1),
     1       PY3P2(MBALP1,MBARP1),PY3P3(MBALP1,MBARP1)
      INTEGER NOBAS,NOVIBS,LENIW,IW1(NOBAS),IW3(NOBAS)
C
      COMMON / NUMMOR / R12BEG,R12END,R32BEG,R32END,NSTSTR
C
      COMMON /ISOTOP/ IQUANT,AMASS
C
      COMMON /VALUES/ RHO,EPS,EPSP,EPSPP,EPSPPP,
     1               CR,SR,CSE,SNE,CRE,SRE,CORO
C
      COMMON /MOLCUL/ RHOE,FA1,FA2,FA3,FA4,FA5,FA6,FA7,FA8,
     1               AA1,AA3,
     1               F11,F33,F13,F111,F333,F113,F133,
     1               F1111,F3333,F1113,F1333,F1133,
     2               F1,F1A1,F2A1,F3A1,F4A1,F3,F1A3,F2A3,F3A3,F4A3,
     3               F1A11,F2A11,F3A11,F1A33,F2A33,F3A33,
     4               F1A13,F2A13,F3A13,
     5               F1A111,F2A111,F1A333,F2A333,
     6               F1A113,F2A113,F1A133,F2A133,
     7               FA1111,FA3333,FA1113,
     8               FA1333,FA1133, R12RF1, R32RF1, R12RF2, R32RF2,
     8               RE12 , RE32 , M1 , M2 , M3 , M ,
     9               U1 , U3 , U13 , V ,
     1               SYMM
      COMMON /RENTEL/G1,G3,G11,G33,G13,G111,G333,G113,G133,
     1               G1111,G3333,G1113,G1333,G1133,
     2               GA1,GA2,GA3,GA4,GA5,GA6,GA7,GA8,
     2               G1A1,G2A1,G3A1,G4A1,G1A3,G2A3,G3A3,G4A3,
     3               G1A11,G2A11,G3A11,G1A33,G2A33,G3A33,
     4               G1A13,G2A13,G3A13,
     5               G1A111,G2A111,G1A333,G2A333,
     6               G1A113,G2A113,G1A133,G2A133,
     7               GA1111,GA3333,GA1113,
     8               GA1333,GA1133,
     1               HA1,HA2,HA3,HA4,HA5,HA6,HA7,HA8,
     2               H1A1,H2A1,H3A1,H4A1,H1A3,H2A3,H3A3,H4A3,
     3               H1A11,H2A11,H3A11,H1A33,H2A33,H3A33,
     4               H1A13,H2A13,H3A13,
     5               H1A111,H2A111,H1A333,H2A333,
     6               H1A113,H2A113,H1A133,H2A133,
     7               HA1111,HA3333,HA1113,
     8               HA1333,HA1133
C
      COMMON /INTEG/  ETRIAL , RHOMAX , PNM1 , HBASE , HSTEP , EGUESS ,
     1               RHOREF , VMINS1 , VMINS2 , ZTRIAL(2) , V0TYPE ,
     1               NSTINT , NSERIN , NSERP , NSERQ , KQUA , NTEST ,
     2               NSEPP2 , NSEQP1 , KSTYPA , LSTYPA
C
      COMMON /DIMEN/ NSURF,  MBASIS ,  V2MAX  , V2MXP1 ,
     1               JMAX   , JMAXP1 , MDIM   , NFSYM0 , NFASY0 ,
     2               NFSYMJ , NFASYJ , NFINTA
C
      COMMON /LSFIT/  PARMAX , NUMPAR , ISOMAX , IVAR
C
      include 'rensys.h'
C
      COMMON/BCOEFF/
     1      B11,B13,B111,B133,B113,
     2      B1111,B1333,B1113,B1133,
     3      B11111,B13333,B11113,B11333,B11133,
     4      B31,B33,B311,B333,B313,
     5      B3111,B3333,B3113,B3133,
     6      B31111,B33333,B31113,B31333,B31133
C
      COMMON/CRCOEF/
     1      CR1,CR3,CR11,CR33,CR13,
     2      CR111,CR333,CR113,CR133,
     3      CR1111,CR3333,CR1113,CR1333,CR1133
C
C
      COMMON/MORSE/RMK,AAS
      COMMON/MODIM/NOBAS,NODUMM,LENIW
C
      RSTEP1 = (R12END - R12BEG)/(NSTSTR-1)
      RSTEP3 = (R32END - R32BEG)/(NSTSTR-1)
C
      DO 1019 II=1,NSTSTR
      R1VAL=R12BEG+DFLOAT(II-1)*RSTEP1
      R3VAL=R32BEG+DFLOAT(II-1)*RSTEP3
      YR1=1.0D+00-EXP(-AA1*(R1VAL-RE12))
      YR3=1.0D+00-EXP(-AA3*(R3VAL-RE32))
      Y1P1(II)=YR1
      Y1P2(II)=YR1*YR1
      Y1P3(II)=YR1*YR1*YR1
      Y1P4(II)=YR1*YR1*YR1*YR1
      Y3P1(II)=YR3
      Y3P2(II)=YR3*YR3
      Y3P3(II)=YR3*YR3*YR3
1019  Y3P4(II)=YR3*YR3*YR3*YR3
      FACOD1=2.0D+00*RSTEP1/3.0D+00
      FACEV1=4.0D+00*RSTEP1/3.0D+00
      FACOD3=2.0D+00*RSTEP3/3.0D+00
      FACEV3=4.0D+00*RSTEP3/3.0D+00
C
      DO 2000 ILFT=0,MBASIL
      READ (NFIL37,REC=ILFT+1) (PHIL1(II), II=1,NSTSTR),
     1                         (DERL1(II), II=1,NSTSTR)
      READ (NFIL38,REC=ILFT+1) (PHIL3(II), II=1,NSTSTR),
     1                         (DERL3(II), II=1,NSTSTR)
      DO 2000 IRGT=0,MBASIR
      READ (NFIL39,REC=IRGT+1) (PHIR1(II), II=1,NSTSTR),
     1                         (DERR1(II), II=1,NSTSTR)
      READ (NFIL40,REC=IRGT+1) (PHIR3(II), II=1,NSTSTR),
     1                         (DERR3(II), II=1,NSTSTR)
      SUM01=0.0D+00
      SUM02=0.0D+00
      SUM03=0.0D+00
      SUM04=0.0D+00
      SUM05=0.0D+00
      XUM01=0.0D+00
      XUM02=0.0D+00
      XUM03=0.0D+00
      XUM04=0.0D+00
      SUM06=0.0D+00
      SUM07=0.0D+00
      SUM08=0.0D+00
      SUM09=0.0D+00
      SUM10=0.0D+00
      XUM05=0.0D+00
      XUM06=0.0D+00
      XUM07=0.0D+00
      XUM08=0.0D+00
C
      DO 1000 II=1,NSTSTR,2
      SUM01=SUM01+FACOD1*PHIL1(II  )*PHIR1(II  )
     1           +FACEV1*PHIL1(II+1)*PHIR1(II+1)
      SUM02=SUM02+FACOD1*PHIL1(II  )*Y1P1(II  )*PHIR1(II  )
     1           +FACEV1*PHIL1(II+1)*Y1P1(II+1)*PHIR1(II+1)
      SUM03=SUM03+FACOD1*PHIL1(II  )*Y1P2(II  )*PHIR1(II  )
     1           +FACEV1*PHIL1(II+1)*Y1P2(II+1)*PHIR1(II+1)
      SUM04=SUM04+FACOD1*PHIL1(II  )*Y1P3(II  )*PHIR1(II  )
     1           +FACEV1*PHIL1(II+1)*Y1P3(II+1)*PHIR1(II+1)
      SUM05=SUM05+FACOD1*PHIL1(II  )*Y1P4(II  )*PHIR1(II  )
     1           +FACEV1*PHIL1(II+1)*Y1P4(II+1)*PHIR1(II+1)
      XUM01=XUM01+FACOD1*PHIL1(II  )*DERR1(II  )
     1           +FACEV1*PHIL1(II+1)*DERR1(II+1)
      XUM02=XUM02+FACOD1*(PHIL1(II  )*DERR1(II  )
     1                   -DERL1(II  )*PHIR1(II  ))*Y1P1(II  )
     1           +FACEV1*(PHIL1(II+1)*DERR1(II+1)
     1                   -DERL1(II+1)*PHIR1(II+1))*Y1P1(II+1)
      XUM03=XUM03+FACOD1*(PHIL1(II  )*DERR1(II  )
     1                   -DERL1(II  )*PHIR1(II  ))*Y1P2(II  )
     1           +FACEV1*(PHIL1(II+1)*DERR1(II+1)
     1                   -DERL1(II+1)*PHIR1(II+1))*Y1P2(II+1)
      XUM04=XUM04+FACOD1*(PHIL1(II  )*DERR1(II  )
     1                   -DERL1(II  )*PHIR1(II  ))*Y1P3(II  )
     1           +FACEV1*(PHIL1(II+1)*DERR1(II+1)
     1                   -DERL1(II+1)*PHIR1(II+1))*Y1P3(II+1)
      SUM06=SUM06+FACOD3*PHIL3(II  )*PHIR3(II  )
     1           +FACEV3*PHIL3(II+1)*PHIR3(II+1)
      SUM07=SUM07+FACOD3*PHIL3(II  )*Y3P1(II  )*PHIR3(II  )
     1           +FACEV3*PHIL3(II+1)*Y3P1(II+1)*PHIR3(II+1)
      SUM08=SUM08+FACOD3*PHIL3(II  )*Y3P2(II  )*PHIR3(II  )
     1           +FACEV3*PHIL3(II+1)*Y3P2(II+1)*PHIR3(II+1)
      SUM09=SUM09+FACOD3*PHIL3(II  )*Y3P3(II  )*PHIR3(II  )
     1           +FACEV3*PHIL3(II+1)*Y3P3(II+1)*PHIR3(II+1)
      SUM10=SUM10+FACOD3*PHIL3(II  )*Y3P4(II  )*PHIR3(II  )
     1           +FACEV3*PHIL3(II+1)*Y3P4(II+1)*PHIR3(II+1)
      XUM05=XUM05+FACOD3*PHIL3(II  )*DERR3(II  )
     1           +FACEV3*PHIL3(II+1)*DERR3(II+1)
      XUM06=XUM06+FACOD3*(PHIL3(II  )*DERR3(II  )
     1                   -DERL3(II  )*PHIR3(II  ))*Y3P1(II  )
     1           +FACEV3*(PHIL3(II+1)*DERR3(II+1)
     1                   -DERL3(II+1)*PHIR3(II+1))*Y3P1(II+1)
      XUM07=XUM07+FACOD3*(PHIL3(II  )*DERR3(II  )
     1                   -DERL3(II  )*PHIR3(II  ))*Y3P2(II  )
     1           +FACEV3*(PHIL3(II+1)*DERR3(II+1)
     1                   -DERL3(II+1)*PHIR3(II+1))*Y3P2(II+1)
1000  XUM08=XUM08+FACOD3*(PHIL3(II  )*DERR3(II  )
     1                   -DERL3(II  )*PHIR3(II  ))*Y3P3(II  )
     1           +FACEV3*(PHIL3(II+1)*DERR3(II+1)
     1                   -DERL3(II+1)*PHIR3(II+1))*Y3P3(II+1)
C
      Y1P0M(ILFT+1,IRGT+1)=SUM01
      Y1P1M(ILFT+1,IRGT+1)=SUM02
      Y1P2M(ILFT+1,IRGT+1)=SUM03
      Y1P3M(ILFT+1,IRGT+1)=SUM04
      Y1P4M(ILFT+1,IRGT+1)=SUM05
      PY1P0(ILFT+1,IRGT+1)=XUM01
      PY1P1(ILFT+1,IRGT+1)=XUM02
      PY1P2(ILFT+1,IRGT+1)=XUM03
      PY1P3(ILFT+1,IRGT+1)=XUM04
      Y3P0M(ILFT+1,IRGT+1)=SUM06
      Y3P1M(ILFT+1,IRGT+1)=SUM07
      Y3P2M(ILFT+1,IRGT+1)=SUM08
      Y3P3M(ILFT+1,IRGT+1)=SUM09
      Y3P4M(ILFT+1,IRGT+1)=SUM10
      PY3P0(ILFT+1,IRGT+1)=XUM05
      PY3P1(ILFT+1,IRGT+1)=XUM06
      PY3P2(ILFT+1,IRGT+1)=XUM07
2000  PY3P3(ILFT+1,IRGT+1)=XUM08
C
C
C
C SET UP THE V1 AND V3 QUANTUM NUMBERS FULFILLING V1+V3 .LE. MBASIS
C
      KBAS=0
      DO 200 ISUMP1=1,NOVIBS
      ISUM=ISUMP1-1
      DO 100 V1P1=1,ISUMP1
      V1=V1P1-1
      V3=ISUM-V1
      IF (V1 .GT. V3) GOTO 100
      KBAS=KBAS+1
      IW1(KBAS)=V1
      IW3(KBAS)=V3
      IF (V1 .EQ. V3) GOTO 100
      KBAS=KBAS+1
      IW1(KBAS)=V3
      IW3(KBAS)=V1
100   CONTINUE
200   CONTINUE
C
C
C
C
C 0. GENERATE MATRIX OF 1
C    (BECAUSE THE STRETCHING FCTS ARE NON-ORTHOGONAL)
C
      KNDEX=1
      DO 1012 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1012 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1012  VMAT(IL,IR)=Y1P0M(IDXL1,IDXR1)*Y3P0M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C 1. GENERATE MATRIX OF Y1
C
      KNDEX=KNDEX+1
      DO 1014 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1014 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1014  VMAT(IL,IR)=Y1P1M(IDXL1,IDXR1)*Y3P0M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  2. GENERATE MATRIX OF Y3
C
      KNDEX=KNDEX+1
      DO 1016 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1016 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1016  VMAT(IL,IR)=Y1P0M(IDXL1,IDXR1)*Y3P1M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  3. GENERATE MATRIX OF Y1*Y1
C
      KNDEX=KNDEX+1
      DO 1018 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1018 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1018  VMAT(IL,IR)=Y1P2M(IDXL1,IDXR1)*Y3P0M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  4. GENERATE MATRIX OF Y3*Y3
C
      KNDEX=KNDEX+1
      DO 1020 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1020 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1020  VMAT(IL,IR)=Y1P0M(IDXL1,IDXR1)*Y3P2M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C   5. GENERATE MATRIX OF Y1*Y3
C
      KNDEX=KNDEX+1
      DO 1022 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1022 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1022  VMAT(IL,IR)=Y1P1M(IDXL1,IDXR1)*Y3P1M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  6. GENERATE MATRIX OF Y1*Y1*Y1
C
      KNDEX=KNDEX+1
      DO 1024 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1024 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1024  VMAT(IL,IR)=Y1P3M(IDXL1,IDXR1)*Y3P0M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  7. GENERATE MATRIX OF Y3*Y3*Y3
C
      KNDEX=KNDEX+1
      DO 1026 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1026 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1026  VMAT(IL,IR)=Y1P0M(IDXL1,IDXR1)*Y3P3M(IDXL3,IDXR3)
      CALL BASTRN(VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  8. GENERATE MATRIX OF Y1*Y1*Y3
C
      KNDEX=KNDEX+1
      DO 1028 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1028 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1028  VMAT(IL,IR)=Y1P2M(IDXL1,IDXR1)*Y3P1M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  9. GENERATE MATRIX OF Y1*Y3*Y3
C
      KNDEX=KNDEX+1
      DO 1030 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1030 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1030  VMAT(IL,IR)=Y1P1M(IDXL1,IDXR1)*Y3P2M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  10. GENERATE MATRIX OF Y1*Y1*Y1*Y1
C
      KNDEX=KNDEX+1
      DO 1032 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1032 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1032  VMAT(IL,IR)=Y1P4M(IDXL1,IDXR1)*Y3P0M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  11. GENERATE MATRIX OF Y3*Y3*Y3*Y3
C
      KNDEX=KNDEX+1
      DO 1034 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1034 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1034  VMAT(IL,IR)=Y1P0M(IDXL1,IDXR1)*Y3P4M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  12. GENERATE MATRIX OF Y1*Y1*Y1*Y3
C
      KNDEX=KNDEX+1
      DO 1036 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1036 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1036  VMAT(IL,IR)=Y1P3M(IDXL1,IDXR1)*Y3P1M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  13. GENERATE MATRIX OF Y1*Y3*Y3*Y3
C
      KNDEX=KNDEX+1
      DO 1038 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1038 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1038  VMAT(IL,IR)=Y1P1M(IDXL1,IDXR1)*Y3P3M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  14. GENERATE MATRIX OF Y1*Y1*Y3*Y3
C
      KNDEX=KNDEX+1
      DO 1040 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1040 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1040  VMAT(IL,IR)=Y1P2M(IDXL1,IDXR1)*Y3P2M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  15. GENERATE MATRIX OF Y1*P1+P1*Y1
C
      KNDEX=KNDEX+1
      DO 1042 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1042 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1042  VMAT(IL,IR)=PY1P1(IDXL1,IDXR1)*Y3P0M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  16. GENERATE MATRIX OF Y3*P3+P3*Y3
C
      KNDEX=KNDEX+1
      DO 1044 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1044 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1044  VMAT(IL,IR)=Y1P0M(IDXL1,IDXR1)*PY3P1(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  17. GENERATE MATRIX OF Y3*P1
C
      KNDEX=KNDEX+1
      DO 1046 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1046 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1046  VMAT(IL,IR)=PY1P0(IDXL1,IDXR1)*Y3P1M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  18. GENERATE MATRIX OF Y1*P3
C
      KNDEX=KNDEX+1
      DO 1048 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1048 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1048  VMAT(IL,IR)=Y1P1M(IDXL1,IDXR1)*PY3P0(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  19. GENERATE MATRIX OF Y1*Y1*P1+P1*Y1*Y1
C
      KNDEX=KNDEX+1
      DO 1050 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1050 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1050  VMAT(IL,IR)=PY1P2(IDXL1,IDXR1)*Y3P0M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  20. GENERATE MATRIX OF Y3*Y3*P3+P3*Y3*Y3
C
      KNDEX=KNDEX+1
      DO 1052 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1052 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1052  VMAT(IL,IR)=Y1P0M(IDXL1,IDXR1)*PY3P2(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  21. GENERATE MATRIX OF Y3*Y3*P1
C
      KNDEX=KNDEX+1
      DO 1054 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1054 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1054  VMAT(IL,IR)=PY1P0(IDXL1,IDXR1)*Y3P2M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  22. GENERATE MATRIX OF Y1*Y1*P3
C
      KNDEX=KNDEX+1
      DO 1056 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1056 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1056  VMAT(IL,IR)=Y1P2M(IDXL1,IDXR1)*PY3P0(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  23. GENERATE MATRIX OF Y3*(Y1*P1+P1*Y1)
C
      KNDEX=KNDEX+1
      DO 1058 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1058 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1058  VMAT(IL,IR)=PY1P1(IDXL1,IDXR1)*Y3P1M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  24. GENERATE MATRIX OF Y1*(Y3*P3+P3*Y3)
C
      KNDEX=KNDEX+1
      DO 1060 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1060 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1060  VMAT(IL,IR)=Y1P1M(IDXL1,IDXR1)*PY3P1(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  25. GENERATE MATRIX OF Y1*Y1*Y1*P1+P1*Y1*Y1*Y1
C
      KNDEX=KNDEX+1
      DO 1062 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1062 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1062  VMAT(IL,IR)=PY1P3(IDXL1,IDXR1)*Y3P0M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  26. GENERATE MATRIX OF Y1*Y1*Y1*P1+P1*Y1*Y1*Y1
C
      KNDEX=KNDEX+1
      DO 1064 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1064 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1064  VMAT(IL,IR)=Y1P0M(IDXL1,IDXR1)*PY3P3(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  27. GENERATE MATRIX OF Y3*Y3*Y3*P1
C
      KNDEX=KNDEX+1
      DO 1066 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1066 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1066  VMAT(IL,IR)=PY1P0(IDXL1,IDXR1)*Y3P3M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  28. GENERATE MATRIX OF Y1*Y1*P3
C
      KNDEX=KNDEX+1
      DO 1068 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1068 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1068  VMAT(IL,IR)=Y1P3M(IDXL1,IDXR1)*PY3P0(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  29. GENERATE MATRIX OF Y3*(Y1*Y1*P1+P1*Y1*Y1)
C
      KNDEX=KNDEX+1
      DO 1070 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1070 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1070  VMAT(IL,IR)=PY1P2(IDXL1,IDXR1)*Y3P1M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  30. GENERATE MATRIX OF Y1*(Y3*Y3*P3+P3*Y3*Y3)
C
      KNDEX=KNDEX+1
      DO 1072 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1072 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1072  VMAT(IL,IR)=Y1P1M(IDXL1,IDXR1)*PY3P2(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  31. GENERATE MATRIX OF Y3*Y3*(Y1*P1+P1*Y1)
C
      KNDEX=KNDEX+1
      DO 1074 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1074 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1074  VMAT(IL,IR)=PY1P1(IDXL1,IDXR1)*Y3P2M(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
C  32. GENERATE MATRIX OF Y1*Y1*(Y3*P3+P3*Y3)
C
      KNDEX=KNDEX+1
      DO 1076 IR=1,NOBAR
      IDXR1=IW1(IR)+1
      IDXR3=IW3(IR)+1
      DO 1076 IL=1,NOBAL
      IDXL1=IW1(IL)+1
      IDXL3=IW3(IL)+1
1076  VMAT(IL,IR)=Y1P2M(IDXL1,IDXR1)*PY3P1(IDXL3,IDXR3)
      CALL BASTRN (VMAT,TMATL,TMATR,SMAT(1,1,KNDEX),WMAT,NOBAL,NOBAR)
C
      RETURN
      END
C
C
      SUBROUTINE BASTRN ( A , UL , UR , B , W , NL , NR )
      INTEGER N,I,J,K
      REAL*8 A(NL,NR),UL(NL,NL),UR(NR,NR),B(NL,NR),
     .W(NR,NL),POM
C
      DO 20 I=1,NL
      DO 20 J=1,NR
      POM=0.0E0
      DO 10 K=1,NL
10    POM=POM+UL(K,I)*A(K,J)
20    W(J,I)=POM
C
      DO 40 I=1,NL
      DO 40 J=1,NR
      POM=0.0E0
      DO 30 K=1,NR
30    POM=POM+W(K,I)*UR(K,J)
40    B(I,J)=POM
C
      RETURN
      END
